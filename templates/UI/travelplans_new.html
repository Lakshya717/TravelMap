{% extends 'partials/layout.html' %}
{% load static %}

{% block title %}
    New Travelpan - TravelMap
{% endblock %}

{% block explicit_CSS %}



{% endblock %} 

{% block content %}
    <div class="container">
        <form method="post">
            {% csrf_token %}

            <!-- Travel Plan base form -->
            <div class="col mb-3">
                <div class="card p-3">
                    <h3>TravelPlan Details</h3>
                    {% include 'partials/django_form.html' with form=plan_form removeSubmit=True %}
                </div>
            </div>

            {{ formset.management_form }}

            <div id="trip-formset" data-prefix="{{ formset.prefix }}">
                {% for form in formset %}
                    <div class="col mb-3 formset-item">
                        <div class="card p-3">
                            <h3>Trip Details</h3>
                            {% include 'partials/django_form.html' with form=form removeSubmit=True %}
                        </div>

                    </div>
                {% endfor %}
            </div>

            <!-- Hidden empty form template used by JS to add new forms dynamically -->
            <template id="empty-form-template">
                <div class="col mb-3 formset-item">
                    <div class="card p-3">
                        <h3>Trip Details</h3>
                        {% include 'partials/django_form.html' with form=formset.empty_form removeSubmit=True %}
                    </div>
                </div>
            </template>

            <button type="button" id="add-form" class="btn btn-outline-primary col-12 col-md-6 mb-3">Add another trip</button>

            <button id="submit" class="btn btn-primary col-12 col-md-6" type="submit">Submit</button>
        </form>
    </div>

    <!-- Reusable full-screen modal for map selection -->
    <div id="search_map" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select on map</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 0; overflow: hidden;">
                    <iframe src="{% url 'UI:search_map' %}" height="100%" width="100%"></iframe>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block explicit_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addBtn = document.getElementById('add-form');
        const container = document.getElementById('trip-formset');
        if (!addBtn || !container) return;

        const prefix = container.dataset.prefix || 'form';
        const totalFormsInput = document.querySelector(`input[name='${prefix}-TOTAL_FORMS']`);
        const template = document.getElementById('empty-form-template');

        if (!totalFormsInput || !template) return;

        // Attach hide-on-delete behavior for existing and future DELETE checkboxes
        function attachDeleteHandlers(scopeEl) {
            const checkboxes = (scopeEl || container).querySelectorAll("input[type='checkbox'][name$='-DELETE']");
            checkboxes.forEach(cb => {
                // Avoid duplicate listeners
                if (cb.dataset.deleteHandlerAttached === '1') return;
                cb.dataset.deleteHandlerAttached = '1';

                const hideOrShow = () => {
                    const item = cb.closest('.formset-item') || cb.closest('.card');
                    if (!item) return;
                    if (cb.checked) {
                        item.classList.add('d-none');
                    } else {
                        item.classList.remove('d-none');
                    }
                };

                cb.addEventListener('change', hideOrShow);

                // Apply initial state (if already checked)
                hideOrShow();
            });
        }

        function getCurrentIndex() {
            const val = parseInt(totalFormsInput.value, 10);
            return isNaN(val) ? 0 : val;
        }

        function incrementTotalForms() {
            const current = getCurrentIndex();
            totalFormsInput.value = String(current + 1);
        }

        // Hide coordinate fields (lat/lon) since they are auto-filled via map selection
        function hideCoordFields(scopeEl) {
            const scope = scopeEl || document;
            const coordInputs = scope.querySelectorAll("input[name$='_lat'], input[name$='_lon']");
            coordInputs.forEach(inp => {
                const group = inp.closest('.mb-3') || inp.parentElement;
                if (group) group.classList.add('d-none');
            });
        }

        addBtn.addEventListener('click', function () {
            const index = getCurrentIndex();
            const html = template.innerHTML.replace(/__prefix__/g, index);

            // Create a wrapper to parse HTML, then extract first root element
            const wrapper = document.createElement('div');
            wrapper.innerHTML = html.trim();
            const newItem = wrapper.firstElementChild;

            // Optional: clear any pre-filled values (should be empty already)
            // Also ensure any id attributes have prefix replaced
            // Already handled via replace above

            container.appendChild(newItem);
            incrementTotalForms();

            // Scroll into view for better UX
            try {
                newItem.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (e) {
                // no-op
            }

            // Wire up delete checkbox behavior for the newly added form
            attachDeleteHandlers(newItem);

            // Attach map buttons for the newly added form
            attachMapButtons(newItem);

            // Hide the new row's coordinate fields to simplify the UI
            hideCoordFields(newItem);
        });

    // Wire up existing delete checkboxes on initial load
    attachDeleteHandlers();

    // Wire up map buttons on initial load
    attachMapButtons(document);

    // Hide coordinate fields on initial load
    hideCoordFields(document);
    });


</script>

<script>
    // Reusable single modal with an iframe to select an address
    let currentMapTarget = null; // { nameInput, latInput, lonInput }

    function makeMapButton(inputEl) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-primary btn-sm mt-2';
        btn.textContent = 'Select on map';
        btn.addEventListener('click', () => {
            // Determine corresponding lat/lon inputs by replacing _name suffix
            const nameAttr = inputEl.getAttribute('name');
            const latName = nameAttr.replace(/_name$/, '_lat');
            const lonName = nameAttr.replace(/_name$/, '_lon');
            const latInput = document.querySelector(`input[name='${latName}']`);
            const lonInput = document.querySelector(`input[name='${lonName}']`);

            currentMapTarget = {
                nameInput: inputEl,
                latInput: latInput,
                lonInput: lonInput,
            };

            const modalEl = document.getElementById('search_map');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        });
        return btn;
    }

    function attachMapButtons(scopeEl) {
        const scope = scopeEl || document;
        const inputs = scope.querySelectorAll("input[name$='-origin_name'], input[name$='-destination_name']");
        inputs.forEach(input => {
            if (input.dataset.mapBtnAttached === '1') return;
            input.dataset.mapBtnAttached = '1';

            // Place the button right after the input
            const btn = makeMapButton(input);
            input.insertAdjacentElement('afterend', btn);
        });
    }

    // Listen for messages from the iframe and fill the target inputs
    window.addEventListener('message', (event) => {
        if (event?.data?.type !== 'addressSelected' || !currentMapTarget) return;
        const { lat, lon, full_response } = event.data.data || {};

        // Fill fields
        if (currentMapTarget.nameInput) {
            const display = full_response?.display_name || `${lat}, ${lon}`;
            currentMapTarget.nameInput.value = display;
        }
        if (currentMapTarget.latInput) currentMapTarget.latInput.value = lat ?? '';
        if (currentMapTarget.lonInput) currentMapTarget.lonInput.value = lon ?? '';

        // Close modal
        const modalEl = document.getElementById('search_map');
        const instance = bootstrap.Modal.getInstance(modalEl);
        if (instance) instance.hide();

        // Reset target
        currentMapTarget = null;
    });
</script>
{% endblock %}